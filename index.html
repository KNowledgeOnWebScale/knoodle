<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Knoodle</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/1.0.0/jsonld.min.js"></script>
  <script src="./bundle.js"></script>
  <script src="./intersection.js"></script>
</head>
<body>
  <div id="slots">

  </div>
</body>
<script type="application/javascript">
  main();

  async function main() {
    const myHeaders = new Headers();
    myHeaders.append('Accept', 'text/turtle');
    const myInit = {
      method: 'GET',
      headers: myHeaders,
      mode: 'cors',
      cache: 'default'
    };
    let myRequest = new Request('http://localhost:3000/availability');
    const response = await fetch(myRequest, myInit);
    const turtle = await response.text();
    //console.log(turtle);
    const parser = new N3.Parser({ format: 'text/turtle' });
    const quads = [];
    parser.parse(turtle, (error, quad, prefixes) => {
      if (quad) {
        quads.push(quad);
      } else {
        const writer = new N3.Writer({ format: 'application/n-quads' });
        writer.addQuads(quads);
        writer.end(async (error, result) => {
          //console.log(result);
          let doc = await jsonld.fromRDF(result, {format: 'application/n-quads'});

          const frame = {
            "@context": {"@vocab": "http://schema.org/"},
            "@type": "Event"
          };
          doc = await jsonld.frame(doc, frame)
          //console.log(doc['@graph']);

          const dummyEvents = [{
            "@id": 'dummy',
            "endDate": "2021-10-22T10:00:00.000Z",
            "startDate": "2021-10-22T09:00:00.000Z"
          },{
            "@id": 'dummy2',
            "endDate": "2021-10-22T14:00:00.000Z",
            "startDate": "2021-10-22T13:00:00.000Z"
          }];
          const dummyEvents2 = [{
            "@id": 'dummy2',
            "endDate": "2021-10-22T14:00:00.000Z",
            "startDate": "2021-10-22T13:00:00.000Z"
          }];
          const slots = intersect(doc['@graph'], dummyEvents, dummyEvents2);

          const $ul = document.createElement('ul');

          slots.forEach(slot => {
            const $li = document.createElement('li');
            $li.innerText = `${slot.startDate} - ${slot.endDate}`;
            $ul.appendChild($li);
          });
          document.getElementById('slots').appendChild($ul);
        });
      }
    });

  }
</script>
</html>