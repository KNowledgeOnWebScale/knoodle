<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Knoodle</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonld/1.0.0/jsonld.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <script src="./bundle.js"></script>
    <script src="./intersection.js"></script>
</head>
<body>
<div id="participants">
    <h3>Select participants</h3>
    <div id="participant-list"></div>
</div>
<div style="padding-top: 20px; padding-bottom: 20px;">
    <button id="btn">Find slots</button>
</div>
<div>
    <h3>Available slots</h3>
    <div id="slots">
    </div>

</div>
</body>
<script type="application/javascript">
  const participants = {
    'https://pieterheyvaert.com/#me': {},
    'dummy1': {
      name: 'Dummy 1',
      calendar: 'test:dummy1'
    },
    'dummy2': {
      name: 'Dummy 2',
      calendar: 'test:dummy2'
    }
  };

  document.getElementById('btn').addEventListener('click', () => {
    const urls = getSelectedParticipantUrls();
    console.log(urls);
    findSlots(urls);
  });

  main();

  async function main() {
    await fetchWebIDs();
    populateParticipants();
  }

  async function fetchWebIDs() {
    const webids = Object.keys(participants);
    const frame = {
      "@context": {
        "@vocab": "http://xmlns.com/foaf/0.1/",
        "knows": "https://data.knows.idlab.ugent.be/person/office/#",
        "schema": "http://schema.org/"
      },
      "@type": "Person"
    };

    for (let i = 0; i < webids.length; i++) {
      const id = webids[i];

      if (id.startsWith('http')) {
        console.log(id);
        const result = await getRDFasJson(id, frame);
        console.log(result);
        participants[id] = {
          name: result[0].name['@value'],
          calendar: result[0]['knows:hasAvailabilityCalendar']['schema:url']
        };
      }
    }

    console.log(participants);
  }

  async function findSlots(urls) {
    const calendars = [];

    const frame = {
      "@context": {"@vocab": "http://schema.org/"},
      "@type": "Event"
    };

    for (let i = 0; i < urls.length; i++) {
      const data = await getRDFasJson(urls[i], frame);
      calendars.push(data);
    }
    const slots = intersect(...calendars);

    const $ul = document.createElement('ul');

    slots.forEach(slot => {
      const $li = document.createElement('li');
      $li.innerText = `${dayjs(slot.startDate).format('dddd YYYY-MM-DD HH:mm')} - ${dayjs(slot.endDate).format('dddd YYYY-MM-DD HH:mm')}`;
      $ul.appendChild($li);
    });
    document.getElementById('slots').innerHTML = '';
    document.getElementById('slots').appendChild($ul);
  }

  function populateParticipants() {
    const webids = Object.keys(participants);
    const $list = document.getElementById('participant-list');
    $list.innerHTML = '';

    webids.forEach(id => {
      const data = participants[id];
      const $div = document.createElement('div');
      const $input = document.createElement('input');
      $input.setAttribute('type', 'checkbox');
      $input.setAttribute('id', id);
      $input.setAttribute('name', id);
      $div.appendChild($input);

      const $label = document.createElement('label');
      $label.setAttribute('for', id);
      $label.innerText = data.name;
      $div.appendChild($label);

      $list.appendChild($div);
    });
  }

  function getSelectedParticipantUrls() {
    const urls = [];
    const webids = Object.keys(participants);

    webids.forEach(id => {
      if (document.getElementById(id).checked) {
        urls.push(participants[id].calendar);
      }
    });

    return urls;
  }

  const dummyData = {
    'test:dummy1': [{
      "@id": 'dummy',
      "endDate": "2021-10-22T10:00:00.000Z",
      "startDate": "2021-10-22T09:00:00.000Z"
    }, {
      "@id": 'dummy2',
      "endDate": "2021-10-22T14:00:00.000Z",
      "startDate": "2021-10-22T13:00:00.000Z"
    }],
    'test:dummy2': [
      {
        "@id": 'dummy',
        "endDate": "2021-10-22T10:00:00.000Z",
        "startDate": "2021-10-22T09:30:00.000Z"
      }, {
        "@id": 'dummy2',
        "endDate": "2021-10-22T14:00:00.000Z",
        "startDate": "2021-10-22T13:30:00.000Z"
      }]
  }

  function getRDFasJson(url, frame) {
    if (url.startsWith('test:')) {
      return dummyData[url];
    }

    return new Promise(async resolve => {
      const myHeaders = new Headers();
      myHeaders.append('Accept', 'text/turtle');
      const myInit = {
        method: 'GET',
        headers: myHeaders,
        mode: 'cors',
        cache: 'default'
      };
      let myRequest = new Request(url);
      const response = await fetch(myRequest, myInit);
      const turtle = await response.text();
      //console.log(turtle);
      const parser = new N3.Parser({format: 'text/turtle'});
      const quads = [];
      parser.parse(turtle, (error, quad, prefixes) => {
        if (quad) {
          quads.push(quad);
        } else {
          const writer = new N3.Writer({format: 'application/n-quads'});
          writer.addQuads(quads);
          writer.end(async (error, result) => {
            console.log(result);
            let doc = await jsonld.fromRDF(result, {format: 'application/n-quads'});
            doc = await jsonld.frame(doc, frame)
            resolve(doc['@graph']);
          });
        }
      });
    });
  }
</script>
</html>